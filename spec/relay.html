<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relay &mdash; interBTC Specification  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Treasury" href="treasury.html" />
    <link rel="prev" title="Security" href="security.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: grey" >
            <a href="../index.html" class="icon icon-home"> interBTC Specification
          </a>
              <div class="version">
                v5.6.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/at-a-glance.html">interBTC at a Glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/CbA.html">Cryptocurrency-backed Assets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/polkadot.html">Polkadot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/bitcoin.html">Bitcoin Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/accepted-format.html">Accepted Bitcoin Transaction Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">How to Read This Specification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Specification</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="btc-relay/index.html">BTC-Relay</a></li>
<li class="toctree-l1"><a class="reference internal" href="collateral.html">Collateral</a></li>
<li class="toctree-l1"><a class="reference internal" href="currency.html">Currency</a></li>
<li class="toctree-l1"><a class="reference internal" href="fee.html">Fee</a></li>
<li class="toctree-l1"><a class="reference internal" href="oracle.html">Oracle</a></li>
<li class="toctree-l1"><a class="reference internal" href="issue.html">Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="refund.html">Refund</a></li>
<li class="toctree-l1"><a class="reference internal" href="redeem.html">Redeem</a></li>
<li class="toctree-l1"><a class="reference internal" href="replace.html">Replace</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Relay</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-storage">Data Storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#maps">Maps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#theftreports">TheftReports</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#functions">Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#report-vault-theft">report_vault_theft</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#specification">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#report-vault-double-payment">report_vault_double_payment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Specification</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#events">Events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#reportvaulttheft">ReportVaultTheft</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="treasury.html">Treasury</a></li>
<li class="toctree-l1"><a class="reference internal" href="vault-registry.html">Vault Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="nomination.html">Vault Nomination</a></li>
<li class="toctree-l1"><a class="reference internal" href="reward.html">Reward</a></li>
<li class="toctree-l1"><a class="reference internal" href="staking.html">Staking</a></li>
<li class="toctree-l1"><a class="reference internal" href="escrow.html">Escrow</a></li>
<li class="toctree-l1"><a class="reference internal" href="governance.html">Governance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security and Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/liquidations.html">Vault Liquidations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/xclaim-security.html">XCLAIM Security Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/btcrelay-security.html">BTC-Relay Security Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/performance.html">Performance Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Economics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../economics/incentives.html">Economic Incentives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../economics/fees.html">Fee Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">All the rest</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../other/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/interlay.html">Interlay</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: grey" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">interBTC Specification</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Relay</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/spec/relay.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="relay">
<span id="id1"></span><h1>Relay<a class="headerlink" href="#relay" title="Permalink to this headline"></a></h1>
<p>The <a class="reference internal" href="#relay"><span class="std std-ref">Relay</span></a> module is responsible for handling theft reporting and block submission to the <a class="reference internal" href="btc-relay/index.html#btc-relay"><span class="std std-ref">BTC-Relay</span></a>.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p><strong>Relayers</strong> are participants whose main role it is to run Bitcoin full nodes and:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Submit valid Bitcoin block headers to earn rewards.</p></li>
<li><p>Check vaults do not move BTC, unless expressly requested during <a class="reference internal" href="redeem.html#redeem-protocol"><span class="std std-ref">Redeem</span></a>, <a class="reference internal" href="replace.html#replace-protocol"><span class="std std-ref">Replace</span></a> or <a class="reference internal" href="refund.html#refund-protocol"><span class="std std-ref">Refund</span></a>.</p></li>
</ol>
</div></blockquote>
<p>In the second case, the module should check the accusation (using a Merkle proof), and liquidate the vault if valid.
It is assumed that there is at least one honest relayer.</p>
<p>The Governance Mechanism votes on critical changes to the architecture or unexpected failures, e.g. hard forks or detected 51% attacks (if a fork exceeds the specified security parameter <em>k</em>, see <a class="reference internal" href="../security_performance/btcrelay-security.html#security-parameter-k"><span class="std std-ref">Security Parameter k</span></a>.</p>
</section>
<section id="data-storage">
<h2>Data Storage<a class="headerlink" href="#data-storage" title="Permalink to this headline"></a></h2>
<section id="maps">
<h3>Maps<a class="headerlink" href="#maps" title="Permalink to this headline"></a></h3>
<section id="theftreports">
<h4>TheftReports<a class="headerlink" href="#theftreports" title="Permalink to this headline"></a></h4>
<p>Mapping of Bitcoin transaction identifiers (SHA256 hashes) to account identifiers of Vaults who have been caught stealing Bitcoin.
Per Bitcoin transaction, multiple Vaults can be accused (multiple inputs can come from multiple Vaults).
This mapping is necessary to prevent duplicate theft reports.</p>
</section>
</section>
</section>
<section id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline"></a></h2>
<section id="report-vault-theft">
<span id="relay-function-report-vault-theft"></span><h3>report_vault_theft<a class="headerlink" href="#report-vault-theft" title="Permalink to this headline"></a></h3>
<p>A relayer reports misbehavior by a vault, providing a fraud proof (malicious Bitcoin transaction and the corresponding transaction inclusion proof).</p>
<p>A vault is not allowed to move BTC from any registered Bitcoin address (as specified by <code class="docutils literal notranslate"><span class="pre">Vault.wallet</span></code>), except in the following three cases:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The vault is executing a <a class="reference internal" href="redeem.html#redeem-protocol"><span class="std std-ref">Redeem</span></a>. In this case, we can link the transaction to a <code class="docutils literal notranslate"><span class="pre">RedeemRequest</span></code> and check the correct recipient.</p></li>
<li><p>The vault is executing a <a class="reference internal" href="replace.html#replace-protocol"><span class="std std-ref">Replace</span></a>. In this case, we can link the transaction to a <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> and check the correct recipient.</p></li>
<li><p>The vault is executing a <a class="reference internal" href="refund.html#refund-protocol"><span class="std std-ref">Refund</span></a>. In this case, we can link the transaction to a <code class="docutils literal notranslate"><span class="pre">RefundRequest</span></code> and check the correct recipient.</p></li>
<li><p>[Optional] The vault is “merging” multiple UTXOs it controls into a single / multiple UTXOs it controls, e.g. for maintenance. In this case, the recipient address of all outputs (e.g. <code class="docutils literal notranslate"><span class="pre">P2PKH</span></code> / <code class="docutils literal notranslate"><span class="pre">P2WPKH</span></code>) must be the same Vault.</p></li>
</ol>
</div></blockquote>
<p>In all other cases, the vault is considered to have stolen the BTC.</p>
<p>This function checks if the vault actually misbehaved (i.e., makes sure that the provided transaction is not one of the above valid cases) and automatically liquidates the vault (i.e., triggers <a class="reference internal" href="redeem.html#redeem-protocol"><span class="std std-ref">Redeem</span></a>).</p>
<section id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this headline"></a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">report_vault_theft(vault,</span> <span class="pre">raw_merkle_proof,</span> <span class="pre">raw_tx)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vaultId</span></code>: the account of the accused Vault.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_merkle_proof</span></code>: Raw Merkle tree path (concatenated LE SHA256 hashes).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_tx</span></code>: Raw Bitcoin transaction including the transaction inputs and outputs.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">txId</span></code> is obtained as the <code class="docutils literal notranslate"><span class="pre">sha256d()</span></code> of the <code class="docutils literal notranslate"><span class="pre">raw_tx</span></code>.</p>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#relay-event-report-vault-theft"><span class="std std-ref">ReportVaultTheft</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST NOT be <code class="docutils literal notranslate"><span class="pre">SHUTDOWN:2</span></code>.</p></li>
<li><p>A vault with id <code class="docutils literal notranslate"><span class="pre">vaultId</span></code> MUST be registered.</p></li>
<li><p>The txId MUST NOT be in <code class="docutils literal notranslate"><span class="pre">TheftReports</span></code> mapping.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">verifyTransactionInclusion</span></code> function in the <a class="reference internal" href="btc-relay/index.html#btc-relay"><span class="std std-ref">BTC-Relay</span></a> component must return true for the derived <code class="docutils literal notranslate"><span class="pre">txId</span></code>.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>The vault MUST be liquidated.</p></li>
<li><p>The vault’s status MUST be set to <code class="docutils literal notranslate"><span class="pre">CommittedTheft</span></code>.</p></li>
<li><p>All token accounts (<code class="docutils literal notranslate"><span class="pre">issuedTokens</span></code>, <code class="docutils literal notranslate"><span class="pre">toBeIssuedTokens</span></code>, etc.) MUST be added to the existing system’s <code class="docutils literal notranslate"><span class="pre">LiquidationVault</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TheftReports</span></code> MUST contain the reported txId.</p></li>
</ul>
</section>
</section>
<section id="report-vault-double-payment">
<span id="relay-function-report-vault-double-payment"></span><h3>report_vault_double_payment<a class="headerlink" href="#report-vault-double-payment" title="Permalink to this headline"></a></h3>
<p>A relayer reports a double payment from a vault, this can destabalize the system if the vault holds less BTC than is reported by the <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>.</p>
<p>Like in <a class="reference internal" href="#relay-function-report-vault-theft"><span class="std std-ref">report_vault_theft</span></a>, if the vault actually misbehaved it is automatically liquidated.</p>
<section id="id2">
<h4>Specification<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">report_vault_double_payment(vault,</span> <span class="pre">raw_merkle_proof1,</span> <span class="pre">raw_tx1,</span> <span class="pre">raw_merkle_proof2,</span> <span class="pre">raw_tx2)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vaultId</span></code>: the account of the accused Vault.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_merkle_proof1</span></code>: The first raw Merkle tree path.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_tx1</span></code>: The first raw Bitcoin transaction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_merkle_proof2</span></code>: The second raw Merkle tree path.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_tx2</span></code>: The second raw Bitcoin transaction.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#relay-event-report-vault-theft"><span class="std std-ref">ReportVaultTheft</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST NOT be <code class="docutils literal notranslate"><span class="pre">SHUTDOWN:2</span></code>.</p></li>
<li><p>A vault with id <code class="docutils literal notranslate"><span class="pre">vaultId</span></code> MUST be registered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_merkle_proof1</span></code> MUST NOT equal <code class="docutils literal notranslate"><span class="pre">raw_merkle_proof2</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_tx1</span></code> MUST NOT equal <code class="docutils literal notranslate"><span class="pre">raw_tx2</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">verifyTransactionInclusion</span></code> function in the <a class="reference internal" href="btc-relay/index.html#btc-relay"><span class="std std-ref">BTC-Relay</span></a> component must return true for the derived <code class="docutils literal notranslate"><span class="pre">txId</span></code>.</p></li>
<li><p>Both transactions MUST NOT be in <code class="docutils literal notranslate"><span class="pre">TheftReports</span></code> mapping.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>The vault MUST be liquidated if both transactions contain the same <code class="docutils literal notranslate"><span class="pre">OP_RETURN</span></code> value.</p></li>
<li><p>The vault’s status MUST be set to <code class="docutils literal notranslate"><span class="pre">CommittedTheft</span></code>.</p></li>
<li><p>All token accounts (<code class="docutils literal notranslate"><span class="pre">issuedTokens</span></code>, <code class="docutils literal notranslate"><span class="pre">toBeIssuedTokens</span></code>, etc.) MUST be added to the existing system’s <code class="docutils literal notranslate"><span class="pre">LiquidationVault</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TheftReports</span></code> MUST contain the reported transactions.</p></li>
</ul>
</section>
</section>
</section>
<section id="events">
<h2>Events<a class="headerlink" href="#events" title="Permalink to this headline"></a></h2>
<section id="reportvaulttheft">
<span id="relay-event-report-vault-theft"></span><h3>ReportVaultTheft<a class="headerlink" href="#reportvaulttheft" title="Permalink to this headline"></a></h3>
<p>Emits an event when a vault has been accused of theft.</p>
<p><em>Event Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">ReportVaultTheft(vault)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vault</span></code>: account identifier of the vault accused of theft.</p></li>
</ul>
<p><em>Functions</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#relay-function-report-vault-theft"><span class="std std-ref">report_vault_theft</span></a></p></li>
<li><p><a class="reference internal" href="#relay-function-report-vault-double-payment"><span class="std std-ref">report_vault_double_payment</span></a></p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="security.html" class="btn btn-neutral float-left" title="Security" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="treasury.html" class="btn btn-neutral float-right" title="Treasury" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Interlay.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>