<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oracle &mdash; interBTC Specification  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Issue" href="issue.html" />
    <link rel="prev" title="Fee" href="fee.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: grey" >
            <a href="../index.html" class="icon icon-home"> interBTC Specification
          </a>
              <div class="version">
                v5.6.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/at-a-glance.html">interBTC at a Glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/CbA.html">Cryptocurrency-backed Assets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/polkadot.html">Polkadot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/bitcoin.html">Bitcoin Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/accepted-format.html">Accepted Bitcoin Transaction Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">How to Read This Specification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Specification</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="btc-relay/index.html">BTC-Relay</a></li>
<li class="toctree-l1"><a class="reference internal" href="collateral.html">Collateral</a></li>
<li class="toctree-l1"><a class="reference internal" href="currency.html">Currency</a></li>
<li class="toctree-l1"><a class="reference internal" href="fee.html">Fee</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Oracle</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-model">Data Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#enums">Enums</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#oraclekey">OracleKey</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#scalars">Scalars</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#maxdelay">MaxDelay</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#maps">Maps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#aggregate">Aggregate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authorizedoracles">AuthorizedOracles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validuntil">ValidUntil</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rawvalues">RawValues</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rawvaluesupdated">RawValuesUpdated</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">AuthorizedOracles</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#functions">Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#feed-values">feed_values</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#specification">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#get-price">get_price</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#convert">convert</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#on-initialize">on_initialize</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">Specification</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#events">Events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#feedvalues">FeedValues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setexchangerate">SetExchangeRate</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="issue.html">Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="refund.html">Refund</a></li>
<li class="toctree-l1"><a class="reference internal" href="redeem.html">Redeem</a></li>
<li class="toctree-l1"><a class="reference internal" href="replace.html">Replace</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="relay.html">Relay</a></li>
<li class="toctree-l1"><a class="reference internal" href="treasury.html">Treasury</a></li>
<li class="toctree-l1"><a class="reference internal" href="vault-registry.html">Vault Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="nomination.html">Vault Nomination</a></li>
<li class="toctree-l1"><a class="reference internal" href="reward.html">Reward</a></li>
<li class="toctree-l1"><a class="reference internal" href="staking.html">Staking</a></li>
<li class="toctree-l1"><a class="reference internal" href="escrow.html">Escrow</a></li>
<li class="toctree-l1"><a class="reference internal" href="governance.html">Governance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security and Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/liquidations.html">Vault Liquidations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/xclaim-security.html">XCLAIM Security Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/btcrelay-security.html">BTC-Relay Security Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/performance.html">Performance Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Economics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../economics/incentives.html">Economic Incentives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../economics/fees.html">Fee Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">All the rest</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../other/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/interlay.html">Interlay</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: grey" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">interBTC Specification</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Oracle</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/spec/oracle.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="oracle">
<span id="id1"></span><h1>Oracle<a class="headerlink" href="#oracle" title="Permalink to this headline"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This oracle model relies on trusted oracle sources. Decentralized oracles are a difficult and open research problem that is outside of the scope of this specification. However, the general interface to get the exchange rate can remain the same even with different constructions.</p>
</div>
<p>The Oracle receives a continuous data feed from off-chain oracles, with information in exchange rates or bitcoin inclusion estimates. Multiple oracles can be authorized, in which case the ‘median’ of all unexpired values is used as the actual value. It is not technically the median - when an even number of oracles have submitted values, it does not average the middle two values. Instead, it arbitrarily picks one of them. This is done because this can be done in O(n) rather than in O(n log n).</p>
<p>In the implementation, the <a class="reference internal" href="#oracle-function-feed-values"><span class="std std-ref">feed_values</span></a> function does not directly update the aggregate - this is done in the <a class="reference internal" href="#oracle-hook-on-initialize"><span class="std std-ref">on_initialize</span></a> hook, in order to keep the <a class="reference internal" href="#oracle-function-feed-values"><span class="std std-ref">feed_values</span></a> function weight independent of the number of oracles. Furthermore, for oracle offline detection and for updating the aggregate when a value becomes outdated, the <a class="reference internal" href="#oracle-hook-on-initialize"><span class="std std-ref">on_initialize</span></a> hook was necessary anyway.</p>
<p>The implementation of the oracle client <strong>is not part of this specification</strong>. InterBTC assumes the oracle operates correctly and that the received data is reliable.</p>
<section id="data-model">
<h2>Data Model<a class="headerlink" href="#data-model" title="Permalink to this headline"></a></h2>
<section id="enums">
<h3>Enums<a class="headerlink" href="#enums" title="Permalink to this headline"></a></h3>
<section id="oraclekey">
<h4>OracleKey<a class="headerlink" href="#oraclekey" title="Permalink to this headline"></a></h4>
<p>Key to indicate a specific value.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Discriminant</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ExchangeRate(CurrencyId)</span></code></p></td>
<td><p>Exchange rate against Bitcoin, in e.g. planck per satoshi.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">FeeEstimation</span></code></p></td>
<td><p>Estimate of the Bitcoin inclusion fee, in satoshis per byte.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="scalars">
<h3>Scalars<a class="headerlink" href="#scalars" title="Permalink to this headline"></a></h3>
<section id="maxdelay">
<span id="id2"></span><h4>MaxDelay<a class="headerlink" href="#maxdelay" title="Permalink to this headline"></a></h4>
<p>The time after which a reported value will no longer be considered valid.</p>
</section>
</section>
<section id="maps">
<h3>Maps<a class="headerlink" href="#maps" title="Permalink to this headline"></a></h3>
<section id="aggregate">
<h4>Aggregate<a class="headerlink" href="#aggregate" title="Permalink to this headline"></a></h4>
<p>Maps <code class="docutils literal notranslate"><span class="pre">oracle_key</span></code> to the median of all unexpired values reported by oracles for that key.</p>
</section>
<section id="authorizedoracles">
<h4>AuthorizedOracles<a class="headerlink" href="#authorizedoracles" title="Permalink to this headline"></a></h4>
<p>The account(s) of the oracle. Returns true if registered as an oracle.</p>
</section>
<section id="validuntil">
<h4>ValidUntil<a class="headerlink" href="#validuntil" title="Permalink to this headline"></a></h4>
<p>Maps oracle_keys to a timestamp that indicates when one of the values expires, at which time a new aggregate needs to be calculated.</p>
</section>
<section id="rawvalues">
<h4>RawValues<a class="headerlink" href="#rawvalues" title="Permalink to this headline"></a></h4>
<p>Maps oracle_keys and account ids to raw timestamped values.</p>
</section>
<section id="rawvaluesupdated">
<h4>RawValuesUpdated<a class="headerlink" href="#rawvaluesupdated" title="Permalink to this headline"></a></h4>
<p>Maps oracle_key to a boolean value that indicates that a new value has been received that has not yet been included in the aggregate.</p>
</section>
<section id="id3">
<h4>AuthorizedOracles<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h4>
<p>Maps oracle <code class="docutils literal notranslate"><span class="pre">accountId</span></code> to the oracle’s name. The presence of an account id in this map indicates that the account is authorized to feed values.</p>
</section>
</section>
</section>
<section id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline"></a></h2>
<section id="feed-values">
<span id="oracle-function-feed-values"></span><h3>feed_values<a class="headerlink" href="#feed-values" title="Permalink to this headline"></a></h3>
<p>The dispatchable function that oracles call to feed new price data into the system.</p>
<section id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this headline"></a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">feed_values(oracle_id,</span> <span class="pre">Vec&lt;oracle_key,</span> <span class="pre">value&gt;)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oracle_id</span></code>: the oracle account calling this function.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oracle_key</span></code>: indicated which value is being set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code>: the value being set</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#oracle-event-feed-values"><span class="std std-ref">FeedValues</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The function call MUST be signed by <code class="docutils literal notranslate"><span class="pre">oracle_id</span></code>.</p></li>
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST NOT be <code class="docutils literal notranslate"><span class="pre">SHUTDOWN:2</span></code>.</p></li>
<li><p>The oracle MUST be authorized.</p></li>
</ul>
<p><em>Postconditions</em></p>
<p>For each <code class="docutils literal notranslate"><span class="pre">(oracle_key,</span> <span class="pre">value)</span></code> pair,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RawValuesUpdated[oracle_key]</span></code> MUST be set to true</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RawValues[oracle_key]</span></code> MUST be set to a <code class="docutils literal notranslate"><span class="pre">TimeStamped</span></code> values, where,</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">TimeStamped.timestamp</span></code> MUST be the current time,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TimeStamped.value</span></code> MUST be <code class="docutils literal notranslate"><span class="pre">value</span></code>.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="get-price">
<span id="oracle-function-get-price"></span><h3>get_price<a class="headerlink" href="#get-price" title="Permalink to this headline"></a></h3>
<p>Returns the latest medianized value for the given key, as calculated from the received external data sources.</p>
<section id="id4">
<h4>Specification<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">get_price(oracle_key)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oracle_key</span></code>: the key for which the value should be returned</p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ExchangeRate[oracle_key]</span></code> MUST NOT be <code class="docutils literal notranslate"><span class="pre">None</span></code>. That is, sufficient oracles must have submitted unexpired values.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>MUST return the fixed point value for the given key.</p></li>
</ul>
</section>
</section>
<section id="convert">
<span id="id5"></span><h3>convert<a class="headerlink" href="#convert" title="Permalink to this headline"></a></h3>
<p>Converts the given amount to the given currency.</p>
<section id="id6">
<h4>Specification<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">convert(amount,</span> <span class="pre">currencyId)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">amount</span></code>: the amount to convert</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">currencyId</span></code>: the currency to convert to</p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>Exactly one of <code class="docutils literal notranslate"><span class="pre">amount.currencyId</span></code> and the <code class="docutils literal notranslate"><span class="pre">currencyId</span></code> argument MUST be the wrapped currency.</p></li>
<li><p>Exactly one of <code class="docutils literal notranslate"><span class="pre">amount.currencyId</span></code> and the <code class="docutils literal notranslate"><span class="pre">currencyId</span></code> argument MUST be a collateral currency.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>MUST return <code class="docutils literal notranslate"><span class="pre">amount</span></code> converted to <code class="docutils literal notranslate"><span class="pre">currencyId</span></code>.</p></li>
</ul>
</section>
</section>
<section id="on-initialize">
<span id="oracle-hook-on-initialize"></span><h3>on_initialize<a class="headerlink" href="#on-initialize" title="Permalink to this headline"></a></h3>
<p>This function is called at the start of every block. When new values have been submitted, or when old values expire, this function update the aggregate value.</p>
<section id="id7">
<h4>Specification<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">on_initialize()</span></code></p>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">RawValuesUpdated</span></code> is empty, i.e., <a class="reference internal" href="#oracle-function-feed-values"><span class="std std-ref">feed_values</span></a> was not yet called since the initialization of the parachain, then the <code class="docutils literal notranslate"><span class="pre">OracleOffline</span></code> MUST be set in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> pallet.</p></li>
<li><p>For each <code class="docutils literal notranslate"><span class="pre">(oracle_key,</span> <span class="pre">updated)</span></code> in <code class="docutils literal notranslate"><span class="pre">RawValuesUpdated</span></code>, if <code class="docutils literal notranslate"><span class="pre">updated</span></code> is true, or the current time is greater than <code class="docutils literal notranslate"><span class="pre">ValidUntil[oracle]</span></code>,</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">RawValuesUpdated[oracle_key]</span></code> MUST be set to false</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ExchangeRate[oracle_key]</span></code> MUST be set to the middle value of the sorted list of unexpired values from <code class="docutils literal notranslate"><span class="pre">RawValues[oracle_key]</span></code>. If there are an even number, one MAY be arbitrarily picked.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ValidUntil[oracle_key]</span></code> MUST be set to <code class="docutils literal notranslate"><span class="pre">MaxDelay</span></code> plus the minimum timestamp from the unexpired values in <code class="docutils literal notranslate"><span class="pre">RawValues[oracle_key]</span></code>.</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>
<section id="events">
<h2>Events<a class="headerlink" href="#events" title="Permalink to this headline"></a></h2>
<section id="feedvalues">
<span id="oracle-event-feed-values"></span><h3>FeedValues<a class="headerlink" href="#feedvalues" title="Permalink to this headline"></a></h3>
</section>
<section id="setexchangerate">
<h3>SetExchangeRate<a class="headerlink" href="#setexchangerate" title="Permalink to this headline"></a></h3>
<p>Emits the new exchange rate when it is updated by the oracle.</p>
<p><em>Event Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">FeedValues(oracle_id,</span> <span class="pre">Vec&lt;(oracle_key,</span> <span class="pre">value)&gt;),</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oracle_id</span></code>: the oracle account calling this function.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oracle_key</span></code>: the key indicating which value is being set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code>: the new value</p></li>
</ul>
<p><em>Function</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#oracle-function-feed-values"><span class="std std-ref">feed_values</span></a></p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fee.html" class="btn btn-neutral float-left" title="Fee" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="issue.html" class="btn btn-neutral float-right" title="Issue" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Interlay.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>